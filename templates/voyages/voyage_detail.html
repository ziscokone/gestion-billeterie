{% extends 'base.html' %}
{% load custom_filters %}

{% block title %}Point du Voyage - {{ voyage.ligne }}{% endblock %}

{% block content %}
<div class="container py-3">
    <!-- En-tête avec boutons d'action -->
    <div class="d-flex justify-content-between align-items-center mb-3">
        <div>
            <h3 class="mb-1"><i class="bi bi-clipboard-data me-2"></i>Point du Voyage</h3>
            <p class="text-muted mb-0 small">Récapitulatif des ventes et liste des passagers</p>
        </div>
        <div class="d-flex gap-2">
            <button type="button" class="btn btn-warning" data-bs-toggle="modal" data-bs-target="#agentsModal">
                <i class="bi bi-people-fill me-2"></i>Agents du voyage
            </button>
            <button type="button" class="btn btn-danger" data-bs-toggle="modal" data-bs-target="#depensesModal">
                <i class="bi bi-cash-coin me-2"></i>Dépenses
            </button>
            {% if user.is_super_admin or user.is_pdg or user.is_chef_gare or user.is_manager %}
            <button type="button" class="btn btn-success" data-bs-toggle="modal" data-bs-target="#bagagesModal">
                <i class="bi bi-luggage me-2"></i>Recette Bagages
            </button>
            {% endif %}
            <a href="{% url 'voyages:voyage_bordereau' voyage.pk %}" class="btn btn-primary" target="_blank">
                <i class="bi bi-file-earmark-text me-2"></i>Voir le Bordereau
            </a>
            <a href="{% url 'voyages:voyage_liste_passagers' voyage.pk %}" class="btn btn-success" target="_blank">
                <i class="bi bi-list-ul me-2"></i>Liste Passagers
            </a>
            <a href="{% url 'voyages:voyage_recap_destination' voyage.pk %}" class="btn btn-info" target="_blank">
                <i class="bi bi-geo-alt me-2"></i>Recap Destination
            </a>
            <a href="{% url 'voyages:voyage_list' %}" class="btn btn-danger text-white fw-bold">
                <i class="bi bi-arrow-left me-2"></i>Retour
            </a>
        </div>
    </div>

    <!-- Informations du voyage -->
    <div class="card mb-3">
        <div class="card-header bg-primary text-white py-2">
            <h6 class="mb-0"><i class="bi bi-info-circle me-2"></i>Informations du Voyage</h6>
        </div>
        <div class="card-body py-2">
            <div class="row g-3">
                <div class="col-md-3">
                    <label class="text-muted small mb-1">Ligne</label>
                    <div class="fw-semibold">
                        <i class="bi bi-signpost-2 me-1"></i>{{ voyage.ligne.nom }}
                    </div>
                </div>
                <div class="col-md-3">
                    <label class="text-muted small mb-1">Date et Heure</label>
                    <div class="fw-semibold">
                        <i class="bi bi-calendar3 me-1"></i>{{ voyage.date_depart|date:"d/m/Y" }}
                        <i class="bi bi-clock ms-2 me-1"></i>{{ voyage.heure_depart|time:"H:i" }}
                        <span class="badge bg-secondary ms-1">Départ N°{{ voyage.numero_depart }}</span>
                    </div>
                </div>
                <div class="col-md-3">
                    <label class="text-muted small mb-1">Véhicule</label>
                    <div class="fw-semibold">
                        {% if voyage.vehicule %}
                            <i class="bi bi-truck me-1"></i>{{ voyage.vehicule.immatriculation }}
                        {% else %}
                            <span class="text-muted">Non assigné</span>
                        {% endif %}
                    </div>
                </div>
                <div class="col-md-3">
                    <label class="text-muted small mb-1">Statut</label>
                    <div class="d-flex align-items-center gap-2">
                        <span class="badge
                            {% if voyage.statut == 'programme' %}bg-info
                            {% elif voyage.statut == 'en_cours' %}bg-warning
                            {% elif voyage.statut == 'termine' %}bg-success
                            {% else %}bg-secondary{% endif %}">
                            {{ voyage.get_statut_display }}
                        </span>
                        {% if voyage.statut == 'programme' or voyage.statut == 'en_cours' %}
                        <button type="button" class="btn btn-sm btn-success" id="terminerVoyageBtn" title="Terminer ce départ">
                            <i class="bi bi-check-circle me-1"></i>Terminer
                        </button>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Statistiques -->
    <div class="row g-3 mb-3">
        <div class="col-md-3">
            <div class="card text-center border-success">
                <div class="card-body py-2">
                    <div class="d-flex align-items-center justify-content-center gap-2">
                        <i class="bi bi-check-circle text-success fs-4"></i>
                        <span class="fs-4 fw-bold text-success">{{ nb_billets_payes }}</span>
                    </div>
                    <small class="text-muted d-block mt-1">Billets Payés</small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center border-warning">
                <div class="card-body py-2">
                    <div class="d-flex align-items-center justify-content-center gap-2">
                        <i class="bi bi-bookmark text-warning fs-4"></i>
                        <span class="fs-4 fw-bold text-warning">{{ nb_billets_reserves }}</span>
                    </div>
                    <small class="text-muted d-block mt-1">Réservations</small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center border-info">
                <div class="card-body py-2">
                    <div class="d-flex align-items-center justify-content-center gap-2">
                        <i class="bi bi-people text-info fs-4"></i>
                        <span class="fs-4 fw-bold text-info">
                            {{ billets.count }}{% if voyage.vehicule %}/{{ voyage.vehicule.modele.capacite }}{% endif %}
                        </span>
                    </div>
                    <small class="text-muted d-block mt-1">Total Passagers</small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center border-primary">
                <div class="card-body py-2">
                    <div class="d-flex align-items-center justify-content-center gap-2">
                        <i class="bi bi-cash-stack text-primary fs-4"></i>
                        <span class="fs-5 fw-bold text-primary">{{ montant_total|format_montant }}</span>
                    </div>
                    <small class="text-muted d-block mt-1">Recette (FCFA)</small>
                </div>
            </div>
        </div>
    </div>

    <!-- Liste des billets vendus -->
    <div class="card">
        <div class="card-header bg-white py-2">
            <div class="d-flex justify-content-between align-items-center">
                <h6 class="mb-0"><i class="bi bi-ticket-perforated me-2"></i>Liste des Passagers ({{ billets.count }})</h6>
                <div class="d-flex align-items-center gap-2 flex-wrap">
                    {% if paiements_cash > 0 %}<span class="badge me-1" style="background-color: #6c757d;">Cash: {{ paiements_cash }}</span>{% endif %}
                    {% if paiements_wave > 0 %}<span class="badge me-1" style="background-color: #00CED1;">Wave: {{ paiements_wave }}</span>{% endif %}
                    {% if paiements_orange > 0 %}<span class="badge me-1" style="background-color: #FF6600;">Orange: {{ paiements_orange }}</span>{% endif %}
                    {% if paiements_mtn > 0 %}<span class="badge me-1" style="background-color: #FFCC00; color: #000;">MTN: {{ paiements_mtn }}</span>{% endif %}
                    {% if paiements_moov > 0 %}<span class="badge me-1" style="background-color: #003366;">Moov: {{ paiements_moov }}</span>{% endif %}
                    <span class="badge bg-success me-1">{{ nb_billets_payes }} Payés</span>
                    <span class="badge bg-warning">{{ nb_billets_reserves }} Réservés</span>
                    {% if voyage.get_nb_places_disponibles > 0 and voyage.statut != 'termine' %}
                    <a href="{% url 'guichet:vente' voyage.pk %}" class="btn btn-sm btn-primary">
                        <i class="bi bi-cart-plus me-1"></i>Vendre des billets
                    </a>
                    {% endif %}
                </div>
            </div>
        </div>
        <div class="card-body p-0">
            {% if billets %}
                <div class="table-responsive">
                    <table class="table table-hover table-striped mb-0">
                        <thead class="table-light sticky-top">
                            <tr>
                                <th class="text-center" style="width: 50px;">N°</th>
                                <th>Nom du Passager</th>
                                <th>Téléphone</th>
                                <th class="text-center" style="width: 80px;">Siège</th>
                                <th>Destination</th>
                                <th class="text-end">Montant</th>
                                <th class="text-center" style="width: 100px;">Statut</th>
                                <th class="text-center" style="width: 80px;">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for billet in billets %}
                            <tr>
                                <td class="text-center">{{ forloop.counter }}</td>
                                <td><strong>{{ billet.client_nom }}</strong></td>
                                <td><i class="bi bi-telephone me-1"></i>{{ billet.client_telephone }}</td>
                                <td class="text-center">
                                    <span class="badge bg-dark">{{ billet.numero_siege }}</span>
                                </td>
                                <td>
                                    <i class="bi bi-geo-alt me-1"></i>
                                    {% if billet.destination %}
                                        {{ billet.destination.ville_arrivee }}
                                    {% else %}
                                        {{ voyage.ligne.ville_arrivee }}
                                    {% endif %}
                                </td>
                                <td class="text-end"><strong>{{ billet.montant|format_montant }} FCFA</strong></td>
                                <td class="text-center">
                                    {% if billet.statut == 'paye' %}
                                        <span class="badge bg-success">Payé</span>
                                        {% if billet.moyen_paiement == 'cash' %}
                                            <span class="badge" style="background-color: #6c757d;">Cash</span>
                                        {% elif billet.moyen_paiement == 'wave' %}
                                            <span class="badge" style="background-color: #00CED1;">Wave</span>
                                        {% elif billet.moyen_paiement == 'orange_money' %}
                                            <span class="badge" style="background-color: #FF6600;">Orange</span>
                                        {% elif billet.moyen_paiement == 'mtn_money' %}
                                            <span class="badge" style="background-color: #FFCC00; color: #000;">MTN</span>
                                        {% elif billet.moyen_paiement == 'moov_money' %}
                                            <span class="badge" style="background-color: #003366;">Moov</span>
                                        {% endif %}
                                    {% else %}
                                        <span class="badge bg-warning">Réservé</span>
                                    {% endif %}
                                </td>
                                <td class="text-center">
                                    <button type="button"
                                            class="btn btn-sm btn-outline-primary btn-reprint"
                                            data-billet-id="{{ billet.pk }}"
                                            title="Réimprimer (Duplicata)">
                                        <i class="bi bi-printer"></i>
                                    </button>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                        <tfoot class="table-light">
                            <tr>
                                <td colspan="5" class="text-end"><strong>TOTAL RECETTE :</strong></td>
                                <td class="text-end"><strong class="text-primary fs-5">{{ montant_total|format_montant }} FCFA</strong></td>
                                <td colspan="2"></td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            {% else %}
                <div class="text-center py-5">
                    <i class="bi bi-inbox" style="font-size: 3rem; color: var(--color-text-muted);"></i>
                    <p class="mt-3 text-muted">Aucun billet vendu pour ce voyage.</p>
                </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Modal d'impression duplicata -->
<div class="modal fade" id="duplicataModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="bi bi-printer me-2"></i>Réimpression - DUPLICATA
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="duplicataContainer">
                <!-- Le ticket duplicata sera inséré ici -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fermer</button>
                <button type="button" class="btn btn-primary" onclick="window.print()">
                    <i class="bi bi-printer me-2"></i>Imprimer
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal Agents du voyage -->
<div class="modal fade" id="agentsModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-warning">
                <h5 class="modal-title">
                    <i class="bi bi-people-fill me-2"></i>Sélection des Agents du Voyage
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="agentsForm">
                    {% csrf_token %}

                    <!-- Sélection du Chauffeur -->
                    <div class="mb-3">
                        <label for="chauffeur_id" class="form-label fw-bold">
                            <i class="bi bi-person-badge me-1"></i>Chauffeur
                        </label>
                        <select class="form-select" id="chauffeur_id" name="chauffeur_id">
                            <option value="">-- Sélectionner un chauffeur --</option>
                            <!-- Options chargées dynamiquement via AJAX -->
                        </select>
                        <div class="form-text">Chauffeur assigné à ce voyage</div>
                    </div>

                    <!-- Sélection du Convoyeur -->
                    <div class="mb-3">
                        <label for="convoyeur_id" class="form-label fw-bold">
                            <i class="bi bi-person-badge me-1"></i>Convoyeur
                        </label>
                        <select class="form-select" id="convoyeur_id" name="convoyeur_id">
                            <option value="">-- Sélectionner un convoyeur --</option>
                            <!-- Options chargées dynamiquement via AJAX -->
                        </select>
                        <div class="form-text">Convoyeur assigné à ce voyage</div>
                    </div>

                    <!-- Affichage des agents actuels -->
                    <div class="alert alert-info">
                        <h6 class="alert-heading">Agents actuellement assignés :</h6>
                        <p class="mb-1">
                            <strong>Chauffeur :</strong>
                            <span id="current_chauffeur">
                                {% if voyage.chauffeur %}
                                    {{ voyage.chauffeur.nom_complet }}
                                {% else %}
                                    <em class="text-muted">Non assigné</em>
                                {% endif %}
                            </span>
                        </p>
                        <p class="mb-0">
                            <strong>Convoyeur :</strong>
                            <span id="current_convoyeur">
                                {% if voyage.convoyeur %}
                                    {{ voyage.convoyeur.nom_complet }}
                                {% else %}
                                    <em class="text-muted">Non assigné</em>
                                {% endif %}
                            </span>
                        </p>
                    </div>

                    <!-- Message de retour -->
                    <div id="agentsMessage" class="alert d-none"></div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                <button type="button" class="btn btn-warning" id="saveAgentsBtn">
                    <i class="bi bi-save me-2"></i>Enregistrer
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal Dépenses du voyage -->
<div class="modal fade" id="depensesModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title">
                    <i class="bi bi-cash-coin me-2"></i>Dépenses du Voyage
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <!-- Formulaire de saisie des dépenses -->
                <div class="card mb-3">
                    <div class="card-header bg-light">
                        <h6 class="mb-0"><i class="bi bi-plus-circle me-2"></i>Saisir les dépenses</h6>
                    </div>
                    <div class="card-body">
                        <form id="depensesForm">
                            {% csrf_token %}
                            <div id="depensesInputs">
                                <!-- Les champs de saisie seront générés dynamiquement ici -->
                            </div>
                            <button type="button" class="btn btn-sm btn-outline-primary mt-2" id="addDepenseLine">
                                <i class="bi bi-plus-circle me-1"></i>Ajouter une autre ligne
                            </button>
                        </form>
                    </div>
                </div>

                <!-- Liste des dépenses existantes -->
                <div class="card mb-3">
                    <div class="card-header bg-light">
                        <h6 class="mb-0"><i class="bi bi-list-ul me-2"></i>Dépenses enregistrées</h6>
                    </div>
                    <div class="card-body">
                        <div id="depensesList" class="table-responsive">
                            <!-- Liste générée dynamiquement -->
                        </div>
                        <div class="mt-3 p-3 bg-light rounded">
                            <h5 class="mb-0">
                                <strong>TOTAL DÉPENSES : </strong>
                                <span id="totalDepenses" class="text-danger">0 FCFA</span>
                            </h5>
                        </div>
                    </div>
                </div>

                <!-- Message de retour -->
                <div id="depensesMessage" class="alert d-none"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fermer</button>
                <button type="button" class="btn btn-danger" id="saveDepensesBtn">
                    <i class="bi bi-save me-2"></i>Enregistrer
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal Recette Bagages -->
<div class="modal fade" id="bagagesModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title">
                    <i class="bi bi-luggage me-2"></i>Recette Bagages
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <!-- Formulaire de saisie -->
                <form id="bagagesForm">
                    {% csrf_token %}
                    <div class="mb-3">
                        <label for="montant_bagages" class="form-label fw-bold">
                            <i class="bi bi-cash-stack me-2"></i>Montant Total des Bagages (FCFA)
                        </label>
                        <input
                            type="number"
                            class="form-control form-control-lg"
                            id="montant_bagages"
                            name="montant_bagages"
                            min="0"
                            step="1"
                            placeholder="Entrez le montant total"
                            required
                        >
                    </div>

                    <div class="alert alert-info">
                        <i class="bi bi-info-circle me-2"></i>
                        <strong>Montant actuel : </strong>
                        <span id="currentBagages" class="fw-bold">0 FCFA</span>
                    </div>
                </form>

                <!-- Message de retour -->
                <div id="bagagesMessage" class="alert d-none"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fermer</button>
                <button type="button" class="btn btn-success" id="saveBagagesBtn">
                    <i class="bi bi-save me-2"></i>Enregistrer
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal de confirmation pour terminer le départ -->
<div class="modal fade" id="terminerVoyageModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title">
                    <i class="bi bi-check-circle me-2"></i>Terminer le départ
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-warning">
                    <i class="bi bi-exclamation-triangle me-2"></i>
                    <strong>Attention :</strong> Vous êtes sur le point de marquer ce départ comme terminé.
                </div>
                <p>Êtes-vous sûr de vouloir terminer ce départ ?</p>
                <p class="mb-0"><strong>Ligne :</strong> {{ voyage.ligne.nom }}</p>
                <p class="mb-0"><strong>Date :</strong> {{ voyage.date_depart|date:"d/m/Y" }} à {{ voyage.heure_depart|time:"H:i" }}</p>

                <!-- Message de retour -->
                <div id="terminerVoyageMessage" class="alert d-none mt-3"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                <button type="button" class="btn btn-success" id="confirmTerminerBtn">
                    <i class="bi bi-check-circle me-2"></i>Confirmer
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const duplicataModal = new bootstrap.Modal(document.getElementById('duplicataModal'));
    const duplicataContainer = document.getElementById('duplicataContainer');
    const agentsModal = new bootstrap.Modal(document.getElementById('agentsModal'));
    const voyageId = {{ voyage.pk }};

    // Fonction pour afficher le ticket duplicata
    function displayDuplicata(billet) {
        duplicataContainer.innerHTML = `
            <div class="ticket-preview ticket-duplicata mb-3">
                <div class="duplicata-watermark">DUPLICATA</div>
                <div class="ticket-content">
                    <div class="ticket-header-row">
                        <div class="ticket-logo">
                            ${billet.compagnie_logo
                                ? `<img src="${billet.compagnie_logo}" alt="Logo" class="ticket-logo-img">`
                                : `<div class="ticket-logo-placeholder"><i class="bi bi-bus-front"></i></div>`
                            }
                        </div>
                        <div class="ticket-gare-info">
                            <strong class="ticket-compagnie-nom">${billet.compagnie_nom || 'COMPAGNIE DE TRANSPORT'}</strong>
                            ${billet.gare_telephone ? `<div class="ticket-gare-tel">Tel: ${billet.gare_telephone}</div>` : ''}
                            ${billet.gare_adresse ? `<div class="ticket-gare-adresse">${billet.gare_adresse}</div>` : ''}
                        </div>
                    </div>
                    <div class="ticket-body">
                        <div class="ticket-row"><span>N° Ticket:</span><strong>${billet.numero}</strong></div>
                        <div class="ticket-row"><span>N° Depart:</span><strong>${billet.numero_depart || 'N/A'}</strong></div>
                        <div class="ticket-row"><span>Client:</span><span>${billet.client_nom}</span></div>
                        <div class="ticket-row"><span>Siege:</span><strong class="ticket-siege">${billet.numero_siege}</strong></div>
                        <hr>
                        <div class="ticket-row"><span>Ligne:</span><span>${billet.ligne}</span></div>
                        <div class="ticket-row"><span>Destination:</span><strong>${billet.destination || 'N/A'}</strong></div>
                        <div class="ticket-row"><span>Date:</span><span>${billet.date_depart}</span></div>
                        <div class="ticket-row"><span>Heure:</span><span>${billet.heure_depart}</span></div>
                        <hr>
                        <div class="ticket-row ticket-montant"><span>Montant:</span><strong>${Number(billet.montant).toLocaleString('fr-FR')} FCFA</strong></div>
                        <div class="ticket-row"><span>Paiement:</span><strong>${billet.moyen_paiement_display || 'Cash'}</strong></div>
                    </div>
                </div>
            </div>
        `;
    }

    // Gestionnaire de clic sur les boutons de réimpression
    document.querySelectorAll('.btn-reprint').forEach(btn => {
        btn.addEventListener('click', function() {
            const billetId = this.dataset.billetId;

            // Afficher un indicateur de chargement
            this.innerHTML = '<span class="spinner-border spinner-border-sm"></span>';
            this.disabled = true;

            fetch(`/api/billet/${billetId}/`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        displayDuplicata(data.billet);
                        duplicataModal.show();
                    } else {
                        alert(data.error || 'Erreur lors de la récupération du billet');
                    }
                })
                .catch(error => {
                    console.error('Erreur:', error);
                    alert('Erreur de connexion');
                })
                .finally(() => {
                    this.innerHTML = '<i class="bi bi-printer"></i>';
                    this.disabled = false;
                });
        });
    });

    // ========== GESTION DES AGENTS DU VOYAGE ==========

    // Charger les listes des chauffeurs et convoyeurs actifs lors de l'ouverture du modal
    document.getElementById('agentsModal').addEventListener('show.bs.modal', function() {
        loadAgents();
    });

    // Fonction pour charger les listes des agents actifs
    function loadAgents() {
        fetch(`/voyages/${voyageId}/agents/`)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Remplir la liste des chauffeurs
                    const chauffeurSelect = document.getElementById('chauffeur_id');
                    chauffeurSelect.innerHTML = '<option value="">-- Sélectionner un chauffeur --</option>';
                    data.chauffeurs.forEach(chauffeur => {
                        const option = document.createElement('option');
                        option.value = chauffeur.id;
                        option.textContent = chauffeur.nom_complet;
                        if (data.voyage.chauffeur_id === chauffeur.id) {
                            option.selected = true;
                        }
                        chauffeurSelect.appendChild(option);
                    });

                    // Remplir la liste des convoyeurs
                    const convoyeurSelect = document.getElementById('convoyeur_id');
                    convoyeurSelect.innerHTML = '<option value="">-- Sélectionner un convoyeur --</option>';
                    data.convoyeurs.forEach(convoyeur => {
                        const option = document.createElement('option');
                        option.value = convoyeur.id;
                        option.textContent = convoyeur.nom_complet;
                        if (data.voyage.convoyeur_id === convoyeur.id) {
                            option.selected = true;
                        }
                        convoyeurSelect.appendChild(option);
                    });
                } else {
                    showAgentsMessage('Erreur lors du chargement des agents', 'danger');
                }
            })
            .catch(error => {
                console.error('Erreur:', error);
                showAgentsMessage('Erreur de connexion', 'danger');
            });
    }

    // Fonction pour enregistrer les agents sélectionnés
    document.getElementById('saveAgentsBtn').addEventListener('click', function() {
        const saveBtn = this;
        const chauffeurId = document.getElementById('chauffeur_id').value;
        const convoyeurId = document.getElementById('convoyeur_id').value;

        // Désactiver le bouton pendant l'enregistrement
        saveBtn.disabled = true;
        saveBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Enregistrement...';

        // Récupérer le token CSRF
        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;

        // Envoyer la requête AJAX
        fetch(`/voyages/${voyageId}/agents/save/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
            },
            body: JSON.stringify({
                chauffeur_id: chauffeurId || null,
                convoyeur_id: convoyeurId || null
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showAgentsMessage('Agents enregistrés avec succès !', 'success');

                // Mettre à jour l'affichage des agents actuels
                document.getElementById('current_chauffeur').innerHTML =
                    data.chauffeur_nom || '<em class="text-muted">Non assigné</em>';
                document.getElementById('current_convoyeur').innerHTML =
                    data.convoyeur_nom || '<em class="text-muted">Non assigné</em>';

                // Recharger la page après 1 seconde pour mettre à jour les informations
                setTimeout(() => {
                    window.location.reload();
                }, 1000);
            } else {
                showAgentsMessage(data.error || 'Erreur lors de l\'enregistrement', 'danger');
            }
        })
        .catch(error => {
            console.error('Erreur:', error);
            showAgentsMessage('Erreur de connexion', 'danger');
        })
        .finally(() => {
            // Réactiver le bouton
            saveBtn.disabled = false;
            saveBtn.innerHTML = '<i class="bi bi-save me-2"></i>Enregistrer';
        });
    });

    // Fonction pour afficher un message dans le modal
    function showAgentsMessage(message, type) {
        const messageDiv = document.getElementById('agentsMessage');
        messageDiv.className = `alert alert-${type}`;
        messageDiv.textContent = message;
        messageDiv.classList.remove('d-none');

        // Masquer le message après 3 secondes
        setTimeout(() => {
            messageDiv.classList.add('d-none');
        }, 3000);
    }

    // ========== GESTION DES DÉPENSES DU VOYAGE ==========

    let typesDepenses = [];
    let depensesExistantes = [];
    let ligneCounter = 0;

    // Charger les données lors de l'ouverture du modal
    document.getElementById('depensesModal').addEventListener('show.bs.modal', function() {
        loadDepenses();
    });

    // Fonction pour charger les types de dépenses et les dépenses existantes
    function loadDepenses() {
        fetch(`/voyages/${voyageId}/depenses/`)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    typesDepenses = data.types_depenses;
                    depensesExistantes = data.depenses;

                    // Générer les champs de saisie
                    generateDepensesInputs();

                    // Afficher la liste des dépenses existantes
                    displayDepensesList();

                    // Afficher le total
                    updateTotal(data.total_depenses);
                } else {
                    showDepensesMessage('Erreur lors du chargement des dépenses', 'danger');
                }
            })
            .catch(error => {
                console.error('Erreur:', error);
                showDepensesMessage('Erreur de connexion', 'danger');
            });
    }

    // Fonction pour générer les champs de saisie pour chaque type de dépense
    function generateDepensesInputs() {
        const container = document.getElementById('depensesInputs');
        container.innerHTML = '';
        ligneCounter = 0;

        typesDepenses.forEach(type => {
            addDepenseInput(type);
        });
    }

    // Fonction pour ajouter un champ de saisie pour un type de dépense
    function addDepenseInput(type) {
        const container = document.getElementById('depensesInputs');
        ligneCounter++;

        const div = document.createElement('div');
        div.className = 'row mb-3 depense-input-row';
        div.dataset.ligneId = ligneCounter;
        div.dataset.typeId = type.id;

        div.innerHTML = `
            <div class="col-md-4">
                <label class="form-label fw-bold">${type.nom}</label>
                <input type="hidden" class="depense-type-id" value="${type.id}">
            </div>
            <div class="col-md-4">
                <input type="number"
                       class="form-control depense-montant"
                       placeholder="Montant (FCFA)"
                       min="0"
                       step="1">
            </div>
            <div class="col-md-4">
                <input type="text"
                       class="form-control depense-description"
                       placeholder="${type.description_obligatoire ? 'Description (obligatoire)' : 'Description (optionnel)'}"
                       ${type.description_obligatoire ? 'required' : ''}>
                ${type.description_obligatoire ? '<div class="form-text text-danger">* Obligatoire si montant renseigné</div>' : ''}
            </div>
        `;

        container.appendChild(div);
    }

    // Bouton "Ajouter une autre ligne"
    document.getElementById('addDepenseLine').addEventListener('click', function() {
        if (typesDepenses.length === 0) {
            showDepensesMessage('Aucun type de dépense disponible', 'warning');
            return;
        }

        // Afficher un sélecteur pour choisir le type
        const type = typesDepenses[0]; // Par défaut, le premier type
        addDepenseInput(type);
    });

    // Fonction pour afficher la liste des dépenses existantes
    function displayDepensesList() {
        const container = document.getElementById('depensesList');

        if (depensesExistantes.length === 0) {
            container.innerHTML = '<p class="text-muted text-center py-3">Aucune dépense enregistrée pour ce voyage.</p>';
            return;
        }

        let html = `
            <table class="table table-sm table-hover">
                <thead class="table-light">
                    <tr>
                        <th>Type</th>
                        <th class="text-end">Montant</th>
                        <th>Description</th>
                        <th>Saisi par</th>
                        <th>Date</th>
                    </tr>
                </thead>
                <tbody>
        `;

        depensesExistantes.forEach(depense => {
            html += `
                <tr>
                    <td><strong>${depense.type_depense_nom}</strong></td>
                    <td class="text-end"><span class="badge bg-danger">${Number(depense.montant).toLocaleString('fr-FR')} FCFA</span></td>
                    <td>${depense.description || '<em class="text-muted">-</em>'}</td>
                    <td><small>${depense.guichetier}</small></td>
                    <td><small>${depense.date_creation}</small></td>
                </tr>
            `;
        });

        html += `
                </tbody>
            </table>
        `;

        container.innerHTML = html;
    }

    // Fonction pour mettre à jour le total des dépenses
    function updateTotal(total) {
        document.getElementById('totalDepenses').textContent = Number(total).toLocaleString('fr-FR') + ' FCFA';
    }

    // Fonction pour enregistrer les dépenses
    document.getElementById('saveDepensesBtn').addEventListener('click', function() {
        const saveBtn = this;

        // Récupérer toutes les lignes de dépenses
        const rows = document.querySelectorAll('.depense-input-row');
        const depenses = [];

        let hasError = false;

        rows.forEach(row => {
            const typeId = row.querySelector('.depense-type-id').value;
            const montant = row.querySelector('.depense-montant').value;
            const description = row.querySelector('.depense-description').value.trim();

            // Ignorer les lignes vides
            if (!montant || parseFloat(montant) <= 0) {
                return;
            }

            // Trouver le type de dépense
            const type = typesDepenses.find(t => t.id == typeId);

            // Vérifier si la description est obligatoire
            if (type && type.description_obligatoire && !description) {
                showDepensesMessage(`La description est obligatoire pour "${type.nom}"`, 'danger');
                hasError = true;
                return;
            }

            depenses.push({
                type_depense_id: parseInt(typeId),
                montant: parseFloat(montant),
                description: description
            });
        });

        if (hasError) {
            return;
        }

        if (depenses.length === 0) {
            showDepensesMessage('Aucune dépense à enregistrer', 'warning');
            return;
        }

        // Désactiver le bouton pendant l'enregistrement
        saveBtn.disabled = true;
        saveBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Enregistrement...';

        // Récupérer le token CSRF
        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;

        // Envoyer la requête AJAX
        fetch(`/voyages/${voyageId}/depenses/add/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
            },
            body: JSON.stringify({
                depenses: depenses
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showDepensesMessage(data.message, 'success');

                // Recharger les données
                setTimeout(() => {
                    loadDepenses();
                }, 500);
            } else {
                showDepensesMessage(data.error || 'Erreur lors de l\'enregistrement', 'danger');
            }
        })
        .catch(error => {
            console.error('Erreur:', error);
            showDepensesMessage('Erreur de connexion', 'danger');
        })
        .finally(() => {
            // Réactiver le bouton
            saveBtn.disabled = false;
            saveBtn.innerHTML = '<i class="bi bi-save me-2"></i>Enregistrer';
        });
    });

    // Fonction pour afficher un message dans le modal
    function showDepensesMessage(message, type) {
        const messageDiv = document.getElementById('depensesMessage');
        messageDiv.className = `alert alert-${type}`;
        messageDiv.textContent = message;
        messageDiv.classList.remove('d-none');

        // Masquer le message après 5 secondes
        setTimeout(() => {
            messageDiv.classList.add('d-none');
        }, 5000);
    }

    // ==================== GESTION RECETTE BAGAGES ====================

    // Charger la recette bagages à l'ouverture du modal
    document.getElementById('bagagesModal').addEventListener('show.bs.modal', function() {
        loadBagages();
    });

    function loadBagages() {
        fetch(`/voyages/${voyageId}/bagages/`)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    document.getElementById('montant_bagages').value = data.recette_bagages;
                    document.getElementById('currentBagages').textContent =
                        `${Number(data.recette_bagages).toLocaleString('fr-FR')} FCFA`;
                } else {
                    showBagagesMessage(data.error || 'Erreur lors du chargement', 'danger');
                }
            })
            .catch(error => {
                console.error('Erreur:', error);
                showBagagesMessage('Erreur de connexion au serveur', 'danger');
            });
    }

    // Enregistrer la recette bagages
    document.getElementById('saveBagagesBtn').addEventListener('click', function() {
        const montant = document.getElementById('montant_bagages').value;

        // Validation
        if (!montant || montant < 0) {
            showBagagesMessage('Veuillez entrer un montant valide', 'warning');
            return;
        }

        // Désactiver le bouton pendant l'enregistrement
        const saveBtn = this;
        saveBtn.disabled = true;
        saveBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Enregistrement...';

        // Envoyer au serveur
        fetch(`/voyages/${voyageId}/bagages/save/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            },
            body: JSON.stringify({
                montant: montant
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showBagagesMessage(data.message, 'success');
                document.getElementById('currentBagages').textContent =
                    `${Number(data.recette_bagages).toLocaleString('fr-FR')} FCFA`;

                // Fermer le modal après 1 seconde
                setTimeout(() => {
                    bootstrap.Modal.getInstance(document.getElementById('bagagesModal')).hide();
                    // Recharger la page pour mettre à jour les totaux
                    location.reload();
                }, 1000);
            } else {
                showBagagesMessage(data.error || 'Erreur lors de l\'enregistrement', 'danger');
            }
        })
        .catch(error => {
            console.error('Erreur:', error);
            showBagagesMessage('Erreur de connexion au serveur', 'danger');
        })
        .finally(() => {
            // Réactiver le bouton
            saveBtn.disabled = false;
            saveBtn.innerHTML = '<i class="bi bi-save me-2"></i>Enregistrer';
        });
    });

    // Fonction pour afficher un message dans le modal bagages
    function showBagagesMessage(message, type) {
        const messageDiv = document.getElementById('bagagesMessage');
        messageDiv.className = `alert alert-${type}`;
        messageDiv.textContent = message;
        messageDiv.classList.remove('d-none');

        // Masquer le message après 5 secondes
        setTimeout(() => {
            messageDiv.classList.add('d-none');
        }, 5000);
    }

    // ==================== GESTION DE LA TERMINAISON DU VOYAGE ====================

    const terminerVoyageBtn = document.getElementById('terminerVoyageBtn');
    const terminerVoyageModal = document.getElementById('terminerVoyageModal');
    const confirmTerminerBtn = document.getElementById('confirmTerminerBtn');

    if (terminerVoyageBtn && terminerVoyageModal) {
        const modal = new bootstrap.Modal(terminerVoyageModal);

        // Ouvrir le modal de confirmation au clic sur le bouton
        terminerVoyageBtn.addEventListener('click', function() {
            modal.show();
        });

        // Confirmer la terminaison
        confirmTerminerBtn.addEventListener('click', function() {
            const btn = this;
            btn.disabled = true;
            btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Traitement...';

            // Envoyer la requête AJAX
            fetch(`/voyages/${voyageId}/terminer/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showTerminerMessage(data.message, 'success');
                    // Recharger la page après 1.5 secondes pour mettre à jour le statut
                    setTimeout(() => {
                        window.location.reload();
                    }, 1500);
                } else {
                    showTerminerMessage(data.error || 'Erreur lors de la terminaison du départ', 'danger');
                    btn.disabled = false;
                    btn.innerHTML = '<i class="bi bi-check-circle me-2"></i>Confirmer';
                }
            })
            .catch(error => {
                console.error('Erreur:', error);
                showTerminerMessage('Erreur de connexion au serveur', 'danger');
                btn.disabled = false;
                btn.innerHTML = '<i class="bi bi-check-circle me-2"></i>Confirmer';
            });
        });

        // Fonction pour afficher un message dans le modal
        function showTerminerMessage(message, type) {
            const messageDiv = document.getElementById('terminerVoyageMessage');
            messageDiv.className = `alert alert-${type} mt-3`;
            messageDiv.textContent = message;
            messageDiv.classList.remove('d-none');
        }
    }
});
</script>
{% endblock %}
